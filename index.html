<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Malla Interactiva ICIIT</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
    header { text-align: center; margin-bottom: 20px; }
    .controls { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
    select, button { padding: 6px 12px; font-size: 1em; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 15px; }
    .card { position: relative; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 12px; cursor: pointer; }
    .card.approved { border-color: #4caf50; background: #e8f5e9; }
    .card h3 { margin: 0 0 8px; font-size: 1.1em; }
    .card p { margin: 4px 0; font-size: 0.9em; }
    .popover { position: absolute; top: 100%; left: 50%; transform: translateX(-50%); width: 200px; background: #fff; border: 1px solid #ccc; border-radius: 6px; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); z-index: 10; }
    .popover h4 { margin: 0 0 6px; font-size: 1em; }
    .popover ul { margin: 0; padding-left: 18px; font-size: 0.9em; }
    .popover ul li { margin: 4px 0; }
  </style>
</head>
<body>
  <header>
    <h1>Malla Interactiva ICIIT</h1>
    <p>Ingeniería Civil Informática e Innovación Tecnológica (UDD)</p>
  </header>

  <div class="controls">
    <select id="semester-select">
      <option value="">-- Selecciona semestre --</option>
    </select>
    <button id="reset-btn">Reset</button>
  </div>

  <div class="grid" id="grid"></div>

  <script>
    // Datos de la malla: semestres 1-10 + English + CELE
    const data = {
      '1': [ /* ... tus cursos ... */, {name:'Inglés Nivel A2-', cr:0, prereqs:[]}, /* ... */ ],
      // ...
      'english': [
        {name:'Inglés Nivel A2-', cr:0, prereqs:[]},
        {name:'Inglés Nivel A2+', cr:0, prereqs:['Inglés Nivel A2-']},
        {name:'Inglés Nivel B1-', cr:0, prereqs:['Inglés Nivel A2+']},
        {name:'Inglés Nivel B1+', cr:0, prereqs:['Inglés Nivel B1-']},
        {name:'Inglés Nivel B2-', cr:0, prereqs:['Inglés Nivel B1+']},
        {name:'Inglés Nivel B2+', cr:0, prereqs:['Inglés Nivel B2-']}
      ],
      'CELE': [
        {name:'Modelado Orgánico 3D: Esculpe Tu Realidad', cr:8, prereqs:[]},
        {name:'Predice Con Inteligencia Artificial', cr:4, prereqs:[]},
        {name:'Créditos Extra Disciplinares de Libre Elección I', cr:8, prereqs:[]},
        {name:'Créditos Extra Disciplinares de Libre Elección II', cr:8, prereqs:[]}
      ]
    };

    // Aseguramos que cada curso tenga prereqs como array
    Object.values(data).forEach(arr =>
      arr.forEach(item => { if (!Array.isArray(item.prereqs)) item.prereqs = []; })
    );

    // Precompute dependents (cursos para los que este es prerequisito)
    const dependents = {};
    Object.values(data).flat().forEach(item => {
      item.prereqs.forEach(pr => {
        if (!dependents[pr]) dependents[pr] = [];
        dependents[pr].push(item.name);
      });
    });

    const select = document.getElementById('semester-select');
    const grid = document.getElementById('grid');

    // Persistencia
    const getState = id => { try { return JSON.parse(localStorage.getItem(id)) || {}; } catch { return {}; } };
    const saveState = (id, state) => localStorage.setItem(id, JSON.stringify(state));

    // Población del selector (con Inglés y CELE)
    Object.keys(data).forEach(key => {
      const opt = document.createElement('option');
      opt.value = key;
      if (key === 'english') {
        opt.textContent = 'Inglés';
      } else if (key === 'CELE') {
        opt.textContent = 'CELE';
      } else {
        opt.textContent = 'Semestre ' + key;
      }
      select.appendChild(opt);
    });

    select.addEventListener('change', () => showSemester(select.value));
    document.getElementById('reset-btn').addEventListener('click', () => {
      localStorage.clear();
      select.value = '';
      grid.innerHTML = '';
    });

    function showSemester(key) {
      grid.innerHTML = '';
      if (!data[key]) return;
      data[key].forEach(item => {
        const id = key + '-' + item.name;
        const state = getState(id);
        const card = document.createElement('div');
        card.className = 'card' + (state.approved ? ' approved' : '');
        card.dataset.id = id;

        const title = document.createElement('h3');
        title.textContent = item.name;
        const credits = document.createElement('p');
        credits.textContent = 'Créditos: ' + item.cr;
        card.append(title, credits);

        // Nota
        const label = document.createElement('label');
        label.textContent = 'Nota:';
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 1;
        input.max = 7;
        input.step = 0.1;
        input.value = state.note || '';
        input.addEventListener('blur', e => {
          state.note = e.target.value;
          saveState(id, state);
        });
        label.append(input);
        card.append(label);

        // Popover de prereqs y dependientes
        card.addEventListener('mouseenter', () => {
          removePopovers();
          const pop = document.createElement('div');
          pop.className = 'popover';
          const h4Deps = document.createElement('h4');
          h4Deps.textContent = 'Debes aprobar:';
          const ulDeps = document.createElement('ul');
          (item.prereqs.length ? item.prereqs : ['Este ramo no tiene prerrequisitos'])
            .forEach(pr => {
              const li = document.createElement('li');
              li.textContent = pr;
              ulDeps.append(li);
            });
          const h4For = document.createElement('h4');
          h4For.textContent = 'Pre-requisito para:';
          const ulFor = document.createElement('ul');
          (dependents[item.name] && dependents[item.name].length
            ? dependents[item.name]
            : ['No es prerrequisito']
          ).forEach(d => {
            const li = document.createElement('li');
            li.textContent = d;
            ulFor.append(li);
          });
          pop.append(h4Deps, ulDeps, h4For, ulFor);
          card.append(pop);
        });
        card.addEventListener('mouseleave', removePopovers);

        // Toggle aprobado
        card.addEventListener('click', () => {
          state.approved = !state.approved;
          saveState(id, state);
          card.classList.toggle('approved', state.approved);
        });

        grid.appendChild(card);
      });
    }

    function removePopovers() {
      document.querySelectorAll('.popover').forEach(el => el.remove());
    }
  </script>
</body>
</html>
